<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éñ„É©„Ç¶„Ç∂„Éî„Ç¢„Éé</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
            touch-action: manipulation;
        }

        .piano-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 95vw;
            overflow-x: auto;
        }

        .title {
            text-align: center;
            color: white;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .piano {
            display: flex;
            position: relative;
            margin: 0 auto;
            min-width: 1650px;
        }

        .key {
            position: relative;
            cursor: pointer;
            transition: all 0.1s ease;
            border: 1px solid #ccc;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f8f8 100%);
            margin: 0 0.5px;
            border-radius: 0 0 8px 8px;
            z-index: 1;
        }

        .white-key:hover {
            background: linear-gradient(to bottom, #f0f0f0 0%, #e8e8e8 100%);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #ddd 0%, #ccc 100%);
            transform: translateY(2px);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.2);
        }

        .black-key {
            width: 30px;
            height: 120px;
            background: linear-gradient(to bottom, #2c2c2c 0%, #000 100%);
            position: absolute;
            border-radius: 0 0 6px 6px;
            z-index: 2;
            color: #999;
        }

        .black-key:hover {
            background: linear-gradient(to bottom, #444 0%, #222 100%);
        }

        .black-key.active {
            background: linear-gradient(to bottom, #555 0%, #333 100%);
            transform: translateY(2px);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.4);
        }

        .controls {
            text-align: center;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .octave-control, .metronome-control {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .metronome-control {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
        }

        .octave-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .octave-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .metronome-btn {
            background: rgba(255,215,0,0.3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 60px;
        }

        .metronome-btn:hover {
            background: rgba(255,215,0,0.4);
            transform: scale(1.05);
        }

        .metronome-btn.active {
            background: rgba(255,215,0,0.6);
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }

        .bpm-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            width: 70px;
            text-align: center;
            font-size: 16px;
        }

        .bpm-input:focus {
            outline: none;
            border-color: rgba(255,215,0,0.6);
            background: rgba(255,255,255,0.15);
        }

        .time-signature-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
        }

        .time-signature-select:focus {
            outline: none;
            border-color: rgba(255,215,0,0.6);
            background: rgba(255,255,255,0.15);
        }

        .time-signature-select option {
            background: #333;
            color: white;
        }

        .accent-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            min-width: 40px;
        }

        .accent-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .accent-btn.active {
            background: rgba(255,215,0,0.4);
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        .accent-btn.inactive {
            background: rgba(128,128,128,0.3);
            color: #999;
        }

        .volume-slider {
            width: 80px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            border: none;
        }

        .octave-display {
            color: white;
            font-size: 18px;
            font-weight: bold;
            min-width: 80px;
        }

            @media (max-width: 768px) {
            .piano-container {
                padding: 15px;
            }
            
            .title {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            .piano {
                min-width: 1250px;
                transform: scale(0.6);
                transform-origin: center;
            }
            
            .white-key {
                width: 40px;
                height: 160px;
            }
            
            .black-key {
                width: 24px;
                height: 100px;
            }
            
            .octave-btn, .metronome-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .control-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .bpm-input {
                width: 60px;
                font-size: 14px;
            }
            
            .time-signature-select {
                font-size: 14px;
                padding: 4px 8px;
            }
            
            .accent-btn {
                padding: 6px 10px;
                font-size: 14px;
                min-width: 35px;
            }
            
            .volume-slider {
                width: 60px;
            }
        }

        @media (max-width: 480px) {
            .piano {
                min-width: 1050px;
                transform: scale(0.45);
            }
            
            .metronome-control {
                padding: 8px 15px;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="piano-container">
        <h1 class="title">üéπ „Éñ„É©„Ç¶„Ç∂„Éî„Ç¢„Éé</h1>
        
        <div class="piano" id="piano">
            <!-- „Éî„Ç¢„Éé„ÅÆÈçµÁõ§„ÅåJavaScript„ÅßÁîüÊàê„Åï„Çå„Åæ„Åô -->
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="octave-control">
                    <button class="octave-btn" id="octaveDown">‚àí</button>
                    <div class="octave-display" id="octaveDisplay">„Ç™„ÇØ„Çø„Éº„Éñ: 4-6</div>
                    <button class="octave-btn" id="octaveUp">+</button>
                </div>
                
                <div class="metronome-control">
                    <button class="metronome-btn" id="metronomeToggle">‚ñ∂Ô∏è</button>
                    <input type="number" class="bpm-input" id="bpmInput" value="120" min="40" max="200">
                    <span style="color: white; font-size: 14px;">BPM</span>
                    <select class="time-signature-select" id="timeSignatureSelect">
                        <option value="4">4/4</option>
                        <option value="3">3/4</option>
                        <option value="2">2/4</option>
                    </select>
                    <button class="accent-btn" id="accentToggle" title="1ÊãçÁõÆÂº∑Ë™ø">üîî</button>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                    <span style="color: white; font-size: 14px;">üîä</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Piano {
            constructor() {
                this.audioContext = null;
                this.currentOctave = 4;
                this.activeNotes = new Set();
                this.keys = [];
                this.metronomeInterval = null;
                this.isMetronomeRunning = false;
                this.bpm = 120;
                this.metronomeVolume = 0.5;
                this.beatCount = 0;
                this.timeSignature = 4; // 4/4ÊãçÂ≠ê„Åå„Éá„Éï„Ç©„É´„Éà
                this.accentEnabled = true; // 1ÊãçÁõÆÂº∑Ë™ø„Çí„Éá„Éï„Ç©„É´„Éà„Åß„Ç™„É≥
                this.keyMapping = {
                    // 1„Ç™„ÇØ„Çø„Éº„ÉñÁõÆ
                    'KeyA': { note: 'C', octave: 0 },
                    'KeyW': { note: 'C#', octave: 0 },
                    'KeyS': { note: 'D', octave: 0 },
                    'KeyE': { note: 'D#', octave: 0 },
                    'KeyD': { note: 'E', octave: 0 },
                    'KeyF': { note: 'F', octave: 0 },
                    'KeyT': { note: 'F#', octave: 0 },
                    'KeyG': { note: 'G', octave: 0 },
                    'KeyY': { note: 'G#', octave: 0 },
                    'KeyH': { note: 'A', octave: 0 },
                    'KeyU': { note: 'A#', octave: 0 },
                    'KeyJ': { note: 'B', octave: 0 },
                    // 2„Ç™„ÇØ„Çø„Éº„ÉñÁõÆ
                    'KeyK': { note: 'C', octave: 1 },
                    'KeyO': { note: 'C#', octave: 1 },
                    'KeyL': { note: 'D', octave: 1 },
                    'KeyP': { note: 'D#', octave: 1 },
                    'Semicolon': { note: 'E', octave: 1 },
                    'Quote': { note: 'F', octave: 1 },
                    'BracketRight': { note: 'F#', octave: 1 },
                    'Enter': { note: 'G', octave: 1 },
                    'Backslash': { note: 'G#', octave: 1 },
                    // ÊúÄÈ´òÈü≥„ÅÆC
                    'Space': { note: 'C', octave: 2 }
                };
                
                this.init();
            }

            async init() {
                this.createPiano();
                this.setupEventListeners();
                
                // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøú
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
            }

            async initAudioContext() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                }
            }

            createPiano() {
                const piano = document.getElementById('piano');
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                
                // 2„Ç™„ÇØ„Çø„Éº„ÉñÂàÜ„ÅÆÈçµÁõ§„Çí‰ΩúÊàê
                for (let octave = 0; octave < 2; octave++) {
                    // ÁôΩÈçµ„Çí‰ΩúÊàê
                    whiteNotes.forEach((note, index) => {
                        const key = document.createElement('div');
                        key.className = 'key white-key';
                        key.dataset.note = note;
                        key.dataset.octave = octave;
                        key.innerHTML = `<div>${note}${octave + this.currentOctave}</div>`;
                        
                        key.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            this.playNote(note, this.currentOctave + octave);
                            key.classList.add('active');
                        });
                        
                        key.addEventListener('mouseup', () => {
                            this.stopNote(note, this.currentOctave + octave);
                            key.classList.remove('active');
                        });
                        
                        key.addEventListener('mouseleave', () => {
                            this.stopNote(note, this.currentOctave + octave);
                            key.classList.remove('active');
                        });
                        
                        piano.appendChild(key);
                        this.keys.push({ element: key, note: note, octave: octave, type: 'white' });
                    });
                }
                
                // ÊúÄÈ´òÈü≥„ÅÆCÔºà3„Ç™„ÇØ„Çø„Éº„ÉñÁõÆ„ÅÆÈñãÂßãÈü≥Ôºâ„ÇíËøΩÂä†
                const highestC = document.createElement('div');
                highestC.className = 'key white-key';
                highestC.dataset.note = 'C';
                highestC.dataset.octave = '2';
                highestC.innerHTML = `<div>C${this.currentOctave + 2}</div>`;
                
                highestC.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.playNote('C', this.currentOctave + 2);
                    highestC.classList.add('active');
                });
                
                highestC.addEventListener('mouseup', () => {
                    this.stopNote('C', this.currentOctave + 2);
                    highestC.classList.remove('active');
                });
                
                highestC.addEventListener('mouseleave', () => {
                    this.stopNote('C', this.currentOctave + 2);
                    highestC.classList.remove('active');
                });
                
                piano.appendChild(highestC);
                this.keys.push({ element: highestC, note: 'C', octave: 2, type: 'white' });
                
                // ÈªíÈçµ„Çí‰ΩúÊàêÔºàÁôΩÈçµ„ÅÆÈñì„Å´ÈÖçÁΩÆÔºâ
                const blackKeyPattern = [1, 1, 0, 1, 1, 1, 0]; // C#, D#, -, F#, G#, A#, -
                const blackNoteNames = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
                
                for (let octave = 0; octave < 2; octave++) {
                    blackKeyPattern.forEach((hasBlackKey, index) => {
                        if (hasBlackKey) {
                            const note = blackNoteNames[index];
                            const key = document.createElement('div');
                            key.className = 'key black-key';
                            key.dataset.note = note;
                            key.dataset.octave = octave;
                            key.innerHTML = `<div>${note}${octave + this.currentOctave}</div>`;
                            
                            // ÈªíÈçµ„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆóÔºàÁôΩÈçµ„ÅÆÂ¢ÉÁïå„Å´ÈÖçÁΩÆÔºâ
                            const whiteKeyWidth = 50.5; // width + margin
                            const leftOffset = (octave * 7 + index) * whiteKeyWidth + (whiteKeyWidth * 0.7);
                            key.style.left = `${leftOffset}px`;
                            
                            key.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                this.playNote(note, this.currentOctave + octave);
                                key.classList.add('active');
                            });
                            
                            key.addEventListener('mouseup', (e) => {
                                e.stopPropagation();
                                this.stopNote(note, this.currentOctave + octave);
                                key.classList.remove('active');
                            });
                            
                            key.addEventListener('mouseleave', () => {
                                this.stopNote(note, this.currentOctave + octave);
                                key.classList.remove('active');
                            });
                            
                            piano.appendChild(key);
                            this.keys.push({ element: key, note: note, octave: octave, type: 'black' });
                        }
                    });
                }
            }

            setupEventListeners() {
                // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
                document.addEventListener('keydown', (e) => {
                    if (this.keyMapping[e.code] && !this.activeNotes.has(e.code)) {
                        e.preventDefault();
                        const keyData = this.keyMapping[e.code];
                        const note = keyData.note;
                        const octave = this.currentOctave + keyData.octave;
                        this.playNote(note, octave);
                        this.activeNotes.add(e.code);
                        this.highlightKey(note, keyData.octave, true);
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    if (this.keyMapping[e.code]) {
                        e.preventDefault();
                        const keyData = this.keyMapping[e.code];
                        const note = keyData.note;
                        const octave = this.currentOctave + keyData.octave;
                        this.stopNote(note, octave);
                        this.activeNotes.delete(e.code);
                        this.highlightKey(note, keyData.octave, false);
                    }
                });
                
                // „Ç™„ÇØ„Çø„Éº„ÉñÂà∂Âæ°
                document.getElementById('octaveUp').addEventListener('click', () => {
                    if (this.currentOctave < 5) { // ÊúÄÈ´òÈü≥C7„Åæ„ÅßÂØæÂøú
                        this.currentOctave++;
                        this.updateOctaveDisplay();
                        this.updateKeyLabels();
                    }
                });
                
                // „É°„Éà„É≠„Éé„Éº„É†Âà∂Âæ°
                document.getElementById('metronomeToggle').addEventListener('click', () => {
                    this.toggleMetronome();
                });
                
                document.getElementById('bpmInput').addEventListener('input', (e) => {
                    this.bpm = parseInt(e.target.value);
                    if (this.isMetronomeRunning) {
                        this.stopMetronome();
                        this.startMetronome();
                    }
                });
                
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    this.metronomeVolume = parseInt(e.target.value) / 100;
                });
                
                document.getElementById('timeSignatureSelect').addEventListener('change', (e) => {
                    this.timeSignature = parseInt(e.target.value);
                    this.beatCount = 0; // ÊãçÂ≠êÂ§âÊõ¥ÊôÇ„Å´„Éì„Éº„Éà„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
                });
                
                document.getElementById('accentToggle').addEventListener('click', () => {
                    this.toggleAccent();
                });
                
                document.getElementById('octaveDown').addEventListener('click', () => {
                    if (this.currentOctave > 1) {
                        this.currentOctave--;
                        this.updateOctaveDisplay();
                        this.updateKeyLabels();
                    }
                });
            }

            handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('key')) {
                    const note = element.dataset.note;
                    const octave = parseInt(element.dataset.octave);
                    this.playNote(note, this.currentOctave + octave);
                    element.classList.add('active');
                }
            }

            handleTouchEnd(e) {
                e.preventDefault();
                this.keys.forEach(key => {
                    const octave = parseInt(key.element.dataset.octave);
                    this.stopNote(key.note, this.currentOctave + octave);
                    key.element.classList.remove('active');
                });
            }

            handleTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                
                // ÂÖ®„Å¶„ÅÆÈçµÁõ§„Çí‰∏ÄÊó¶ÂÅúÊ≠¢
                this.keys.forEach(key => {
                    if (key.element.classList.contains('active')) {
                        const octave = parseInt(key.element.dataset.octave);
                        this.stopNote(key.note, this.currentOctave + octave);
                        key.element.classList.remove('active');
                    }
                });
                
                // ÁèæÂú®Ëß¶„Çå„Å¶„ÅÑ„ÇãÈçµÁõ§„ÇíÂÜçÁîü
                if (element && element.classList.contains('key')) {
                    const note = element.dataset.note;
                    const octave = parseInt(element.dataset.octave);
                    this.playNote(note, this.currentOctave + octave);
                    element.classList.add('active');
                }
            }

            async playNote(note, octave = null) {
                await this.initAudioContext();
                
                const targetOctave = octave || this.currentOctave;
                const frequency = this.getFrequency(note, targetOctave);
                const noteKey = `${note}-${targetOctave}`;
                
                // „Ç™„Ç∑„É¨„Éº„Çø„Éº„Çí‰ΩúÊàê
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'triangle'; // „Çà„ÇäÊüî„Çâ„Åã„ÅÑÈü≥Ëâ≤
                
                // „Ç®„É≥„Éô„É≠„Éº„ÉóÔºàÈü≥„ÅÆÁ´ã„Å°‰∏ä„Åå„Çä„Å®Ê∏õË°∞Ôºâ
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.1, this.audioContext.currentTime + 0.3);
                
                oscillator.start();
                
                // Èü≥Á¨¶„Éá„Éº„Çø„Çí‰øùÂ≠ò
                if (!this.playingNotes) this.playingNotes = new Map();
                this.playingNotes.set(noteKey, { oscillator, gainNode });
            }

            stopNote(note, octave = null) {
                if (!this.playingNotes) return;
                
                const targetOctave = octave || this.currentOctave;
                const noteKey = `${note}-${targetOctave}`;
                const noteData = this.playingNotes.get(noteKey);
                if (noteData) {
                    const { oscillator, gainNode } = noteData;
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                    this.playingNotes.delete(noteKey);
                }
            }

            getFrequency(note, octave) {
                // A4 = 442Hz „ÇíÂü∫Ê∫ñ„Å®„Åó„Åü12Âπ≥ÂùáÂæã„ÅÆË®àÁÆó
                // ÂêÑÈü≥„ÅÆA4„Åã„Çâ„ÅÆÂçäÈü≥Êï∞
                const semitoneFromA4 = {
                    'C': -9,   // A4„Åã„Çâ9ÂçäÈü≥‰∏ã
                    'C#': -8,  // A4„Åã„Çâ8ÂçäÈü≥‰∏ã
                    'D': -7,   // A4„Åã„Çâ7ÂçäÈü≥‰∏ã
                    'D#': -6,  // A4„Åã„Çâ6ÂçäÈü≥‰∏ã
                    'E': -5,   // A4„Åã„Çâ5ÂçäÈü≥‰∏ã
                    'F': -4,   // A4„Åã„Çâ4ÂçäÈü≥‰∏ã
                    'F#': -3,  // A4„Åã„Çâ3ÂçäÈü≥‰∏ã
                    'G': -2,   // A4„Åã„Çâ2ÂçäÈü≥‰∏ã
                    'G#': -1,  // A4„Åã„Çâ1ÂçäÈü≥‰∏ã
                    'A': 0,    // A4
                    'A#': 1,   // A4„Åã„Çâ1ÂçäÈü≥‰∏ä
                    'B': 2     // A4„Åã„Çâ2ÂçäÈü≥‰∏ä
                };
                
                // A4 = 442Hz
                const A4_FREQUENCY = 442.0;
                
                // 12Âπ≥ÂùáÂæã: Âë®Ê≥¢Êï∞ = A4 * 2^(ÂçäÈü≥Êï∞/12)
                // „Ç™„ÇØ„Çø„Éº„Éñ„Å´„Çà„ÇãË™øÊï¥: octave-4 ÂàÜ„Å†„Åë„Ç™„ÇØ„Çø„Éº„Éñ„Ç∑„Éï„Éà
                const totalSemitones = semitoneFromA4[note] + (octave - 4) * 12;
                const frequency = A4_FREQUENCY * Math.pow(2, totalSemitones / 12);
                
                // Â∞èÊï∞ÁÇπÁ¨¨4‰Ωç„Åæ„ÅßÊ≠£Á¢∫„Å´Ë°®Áèæ
                return Math.round(frequency * 10000) / 10000;
            }

            highlightKey(note, octave, active) {
                const key = this.keys.find(k => k.note === note && k.octave === octave);
                if (key) {
                    if (active) {
                        key.element.classList.add('active');
                    } else {
                        key.element.classList.remove('active');
                    }
                }
            }

            updateOctaveDisplay() {
                document.getElementById('octaveDisplay').textContent = `„Ç™„ÇØ„Çø„Éº„Éñ: ${this.currentOctave}-${this.currentOctave + 2}`;
            }

            updateKeyLabels() {
                this.keys.forEach(key => {
                    const displayOctave = this.currentOctave + key.octave;
                    key.element.innerHTML = `<div>${key.note}${displayOctave}</div>`;
                });
            }

            toggleMetronome() {
                if (this.isMetronomeRunning) {
                    this.stopMetronome();
                } else {
                    this.startMetronome();
                }
            }

            async startMetronome() {
                await this.initAudioContext();
                this.isMetronomeRunning = true;
                this.beatCount = 1; // 1„Åã„ÇâÈñãÂßãÔºàÊúÄÂàù„ÅÆÈü≥„ÇíÈ´ò„Åè„Åô„Çã„Åü„ÇÅÔºâ
                
                const toggleBtn = document.getElementById('metronomeToggle');
                toggleBtn.textContent = '‚è∏Ô∏è';
                toggleBtn.classList.add('active');
                
                const interval = 60000 / this.bpm; // „Éü„É™Áßí
                
                // ÊúÄÂàù„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇíÂç≥Â∫ß„Å´ÂÜçÁîüÔºà1ÊãçÁõÆ„Å™„ÅÆ„ÅßÈ´ò„ÅÑÈü≥Ôºâ
                this.playMetronomeClick();
                
                this.metronomeInterval = setInterval(() => {
                    this.beatCount++;
                    if (this.beatCount > this.timeSignature) {
                        this.beatCount = 1; // ÊãçÂ≠ê„Å´Âøú„Åò„Å¶„É™„Çª„ÉÉ„Éà
                    }
                    this.playMetronomeClick();
                }, interval);
            }

            stopMetronome() {
                this.isMetronomeRunning = false;
                
                if (this.metronomeInterval) {
                    clearInterval(this.metronomeInterval);
                    this.metronomeInterval = null;
                }
                
                const toggleBtn = document.getElementById('metronomeToggle');
                toggleBtn.textContent = '‚ñ∂Ô∏è';
                toggleBtn.classList.remove('active');
                
                this.beatCount = 0;
            }

            async playMetronomeClick() {
                if (!this.audioContext || this.metronomeVolume === 0) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                // 1ÊãçÁõÆÂº∑Ë™ø„ÅÆË®≠ÂÆö„Å´Âøú„Åò„Å¶Èü≥Á®ã„Å®Èü≥Èáè„ÇíÊ±∫ÂÆö
                const isStrongBeat = this.beatCount === 1 && this.accentEnabled;
                const frequency = isStrongBeat ? 1200 : 700;
                const volume = isStrongBeat ? this.metronomeVolume * 0.4 : this.metronomeVolume * 0.25;
                const duration = isStrongBeat ? 0.15 : 0.1;
                
                // „Ç¢„ÇØ„Çª„É≥„Éà„ÅåÁÑ°Âäπ„ÅÆÂ†¥Âêà„ÅØÂÖ®„Å¶„ÅÆÊãç„ÇíÂêå„ÅòÈü≥Á®ã„ÉªÈü≥Èáè„Å´„Åô„Çã
                if (!this.accentEnabled) {
                    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                } else {
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                }
                
                oscillator.type = 'square';
                
                // „É°„Éà„É≠„Éé„Éº„É†Èü≥„ÅÆ„Ç®„É≥„Éô„É≠„Éº„Éó
                const finalVolume = this.accentEnabled ? volume : this.metronomeVolume * 0.3;
                const finalDuration = this.accentEnabled ? duration : 0.1;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(
                    finalVolume, 
                    this.audioContext.currentTime + 0.01
                );
                gainNode.gain.exponentialRampToValueAtTime(
                    0.001, 
                    this.audioContext.currentTime + finalDuration
                );
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + finalDuration);
            }

            toggleAccent() {
                this.accentEnabled = !this.accentEnabled;
                const accentBtn = document.getElementById('accentToggle');
                
                if (this.accentEnabled) {
                    accentBtn.classList.remove('inactive');
                    accentBtn.classList.add('active');
                    accentBtn.textContent = 'üîî';
                    accentBtn.title = '1ÊãçÁõÆÂº∑Ë™ø„Ç™„É≥';
                } else {
                    accentBtn.classList.remove('active');
                    accentBtn.classList.add('inactive');
                    accentBtn.textContent = 'üîï';
                    accentBtn.title = '1ÊãçÁõÆÂº∑Ë™ø„Ç™„Éï';
                }
            }
        }

        // „Éî„Ç¢„Éé„ÇíÂàùÊúüÂåñ
        const piano = new Piano();

        // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„Çπ„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
        document.addEventListener('touchmove', function(e) {
            if (e.target.classList.contains('key')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
